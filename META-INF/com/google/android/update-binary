#!/sbin/sh

# Flashable installer for the Kitsunping Magisk module.
# - Prepares a temporary workspace via Magisk utilities.
# - Extracts module files and runs setup.sh to stage assets.
# - Copies service scripts, applies permissions, and cleans build-only files.
# - Leaves a concise install log under /data/adb/logs.

# --- Constants and defaults ---
UMASK=022
PERSISTDIR="/sbin/.magisk/mirror/persist"
NVBASE="/data/adb"
LOGDIR="$NVBASE/logs"

umask "$UMASK"

# --- Small helpers ---
ui_print() { echo "$@"; }
log_line() { [ -n "$LOGFILE" ] && echo "$1" | tee -a "$LOGFILE" || echo "$1"; }

copy_file_if_exists() {
  local src="$TMPDIR/scripts/$1"
  local dest="$MODPATH/$1"

  if [ -f "$src" ]; then
    cp -af "$src" "$dest" || { log_line " [x] Error al copiar $1"; exit 1; }
    log_line " [âœ“] Copiado: [$src] --> [$dest]"
  else
    log_line " [x] Archivo faltante: $1"
    exit 1
  fi
}

# --- Setup environment ---
OUTFD="$2"
ZIPFILE="$3"

mount /data 2>/dev/null
. "/data/adb/magisk/util_functions.sh"
setup_flashable
mount_partitions
api_level_arch_detect

if [ "$BOOTMODE" ]; then
  boot_actions
else
  recovery_actions
fi

# --- Preparation ---
trap 'rm -rf "$TMPDIR"' EXIT
unzip -o "$ZIPFILE" -d "$TMPDIR" >&2 || { echo " [x] ZIP file extraction failed"; exit 1; }

if [ "$BOOTMODE" ]; then
  MODDIRNAME="modules_update"
else
  MODDIRNAME="modules"
fi

MODID=$(grep_prop "id" "$TMPDIR/module.prop")
MODNAME=$(grep_prop "name" "$TMPDIR/module.prop")
MODVERS=$(grep_prop "version" "$TMPDIR/module.prop")
MODULEROOT="$NVBASE/$MODDIRNAME"
MODPATH="$MODULEROOT/$MODID"
NEWMODPATH="$MODULEROOT/$MODID"
LOGFILE="$LOGDIR/${MODID}_up_binary.log"

mkdir -p "$LOGDIR"

if [ -z "$MODID" ] || [ -z "$MODNAME" ] || [ -z "$MODVERS" ]; then
  log_line " [x] Error: Missing module information (ID, Name, Version)."
  exit 1
fi

# Clean up previous installation
if [ -d "$MODPATH" ]; then
  log_line " [i] Previous installation detected, removing old module files..."
  rm -rf "$MODPATH" || { log_line " [SYS] [up-bi] Failed to remove old module files"; exit 1; }
fi

# Create module directory
if ! mkdir -p "$MODPATH" 2>/dev/null; then
  log_line " [x] Failed to create directory $MODPATH"
  exit 1
fi

# --- Installation ---
if unzip -o "$ZIPFILE" -d "$MODPATH" >&2; then
  log_line " [i] Files extracted successfully"
else
  log_line " [x] ZIP file extraction failed"
  exit 1
fi

# Ejecutar setup
if [ -f "$MODPATH/setup.sh" ]; then
  log_line " [i] setup.sh file found, setting executable permissions and continuing installation"
  chmod +x "$MODPATH/setup.sh" || { log_line " [x] Failed to set executable permissions on setup.sh"; exit 1; }
  set_perm "$MODPATH/setup.sh" 0 0 0755 u:object_r:system_file:s0
  set_perm "$MODPATH/addon/Net_Calibrate/calibrate.sh" 0 0 0755 u:object_r:system_file:s0
  . "$MODPATH/setup.sh"
else
  log_line " [x] setup.sh not found, canceling installation"
  exit 1
fi

copy_file_if_exists "service.sh"
copy_file_if_exists "uninstall.sh"
copy_file_if_exists "post-fs-data.sh"

[ "$DEBUG" = "true" ] && set -x
[ "$SKIPMOUNT" = "true" ] && touch "$MODPATH/skip_mount"

set_permissions

for TARGET in $REPLACE; do
  log_line "[*] Replacing destination: $TARGET"
  mktouch "$MODPATH$TARGET/.replace"
done

if [ "$BOOTMODE" = "true" ]; then
  mktouch "$NVBASE/modules/$MODID/update"
  cp -af "$MODPATH/module.prop" "$NVBASE/modules/$MODID/module.prop"
fi

if [ -f "$MODPATH/sepolicy.rule" ]; then
  copy_sepolicy_rules
fi

# Clean build-only assets but keep addon/functions/{debug,utils}
rm -rf "$MODPATH/scripts"
rm -rf "$MODPATH/META-INF"
rm -rf "$MODPATH/setup.sh"
rm -rf "$MODPATH/net_profiles"
rm -rf "$MODPATH/CHANGELOG.md"


log_line " [i] Installation/update process completed"
log_line " [i] You can now restart the device"

cd /
[ "$BOOTMODE" != "true" ] && recovery_cleanup

exit 0